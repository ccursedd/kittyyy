<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PASTEBIN</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0C0C0C;
            color: #fff;
        }

        /* Navigation */
        .navbar {
            background: #181818;
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-weight: 700;
            font-size: 24px;
            color: #fff;
            text-decoration: none;
            cursor: pointer;
            background: linear-gradient(45deg, #fff, #888);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-links {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .nav-links a {
            color: #888;
            text-decoration: none;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s;
            padding: 5px 0;
            border-bottom: 2px solid transparent;
        }

        .nav-links a:hover {
            color: #fff;
            border-bottom-color: #ff4444;
        }

        .search-box {
            background: #282828;
            border: 1px solid #333;
            padding: 10px 15px;
            color: #fff;
            width: 300px;
            border-radius: 6px;
            font-size: 14px;
        }

        .search-box:focus {
            outline: none;
            border-color: #ff4444;
        }

        /* Main container */
        .container {
            display: flex;
            max-width: 1400px;
            margin: 30px auto;
            gap: 30px;
            padding: 0 30px;
        }

        .main-content {
            flex: 2;
        }

        /* Paste List */
        .paste-list {
            background: #181818;
            padding: 25px;
            border-radius: 8px;
            border: 1px solid #282828;
        }

        .paste-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            color: #888;
            font-size: 14px;
            padding-bottom: 15px;
            border-bottom: 1px solid #282828;
        }

        .paste-item {
            padding: 20px;
            border-bottom: 1px solid #282828;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            cursor: pointer;
            border-radius: 4px;
        }

        .paste-item:hover {
            background: #222;
            transform: translateX(5px);
        }

        .paste-item:last-child {
            border-bottom: none;
        }

        .paste-title {
            color: #fff;
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .paste-meta {
            color: #888;
            font-size: 13px;
            display: flex;
            gap: 20px;
        }

        .paste-meta i {
            margin-right: 5px;
            color: #666;
        }

        /* Sidebar */
        .user-sidebar {
            flex: 1;
            background: #181818;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            height: fit-content;
            position: sticky;
            top: 100px;
            border: 1px solid #282828;
        }

        .profile-header {
            position: relative;
            margin-bottom: 20px;
        }

        .banner {
            height: 100px;
            background: linear-gradient(45deg, #333, #444);
            border-radius: 8px 8px 0 0;
            margin: -25px -25px 0 -25px;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #333;
            margin: -50px auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: #666;
            border: 4px solid #181818;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .avatar:hover {
            transform: scale(1.05);
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: #fff;
            font-size: 12px;
            padding: 5px;
            display: none;
        }

        .avatar:hover .avatar-upload {
            display: block;
        }

        .username {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .user-bio {
            color: #888;
            font-size: 13px;
            margin: 10px 0;
            padding: 0 10px;
            line-height: 1.5;
        }

        .user-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            padding: 15px 0;
            border-top: 1px solid #282828;
            border-bottom: 1px solid #282828;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            color: #fff;
            font-weight: 700;
            font-size: 20px;
        }

        .stat-label {
            color: #888;
            font-size: 12px;
            margin-top: 5px;
        }

        .button {
            background: #333;
            color: #fff;
            border: none;
            padding: 12px 20px;
            width: 100%;
            margin: 8px 0;
            cursor: pointer;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .button:hover {
            background: #444;
            transform: translateY(-2px);
        }

        .button-primary {
            background: #ff4444;
        }

        .button-primary:hover {
            background: #ff6666;
        }

        .button-danger {
            background: #753B3B;
        }

        .button-danger:hover {
            background: #8B4B4B;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a1a;
            padding: 30px;
            width: 600px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 12px;
            border: 1px solid #333;
            animation: modalSlideIn 0.3s;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #282828;
        }

        .modal-header h3 {
            font-size: 22px;
            font-weight: 600;
        }

        .close {
            color: #888;
            font-size: 28px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close:hover {
            color: #fff;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #888;
            font-size: 13px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            background: #282828;
            border: 1px solid #333;
            padding: 12px 15px;
            color: #fff;
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #ff4444;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .tab {
            padding: 10px 20px;
            background: #282828;
            color: #888;
            cursor: pointer;
            border: none;
            font-size: 14px;
            font-weight: 500;
            border-radius: 6px;
            flex: 1;
            transition: all 0.2s;
        }

        .tab.active {
            background: #ff4444;
            color: #fff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .upload-area {
            border: 2px dashed #444;
            padding: 50px 20px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .upload-area:hover {
            border-color: #ff4444;
            background: #222;
        }

        .upload-area i {
            font-size: 48px;
            color: #666;
            margin-bottom: 15px;
        }

        .error {
            color: #ff4444;
            font-size: 13px;
            margin-top: 8px;
            padding: 8px;
            background: rgba(255,68,68,0.1);
            border-radius: 4px;
        }

        .success {
            color: #44ff44;
            font-size: 13px;
            margin-top: 5px;
        }

        .pinned-badge {
            background: #ffd700;
            color: #000;
            padding: 3px 8px;
            font-size: 11px;
            border-radius: 12px;
            margin-left: 10px;
            font-weight: 600;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #333;
            color: #fff;
            padding: 15px 25px;
            border-radius: 8px;
            display: none;
            z-index: 2000;
            animation: slideIn 0.3s;
            border-left: 4px solid #ff4444;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Paste View */
        .paste-view {
            background: #181818;
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #282828;
        }

        .paste-view-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #282828;
        }

        .paste-view-meta {
            display: flex;
            gap: 30px;
            margin-bottom: 25px;
            color: #888;
            font-size: 14px;
            flex-wrap: wrap;
        }

        .paste-view-content {
            background: #282828;
            padding: 25px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            margin: 25px 0;
            border: 1px solid #333;
        }

        .reaction-buttons {
            display: flex;
            gap: 20px;
            margin: 25px 0;
        }

        .reaction-button {
            background: #282828;
            border: 1px solid #333;
            color: #888;
            padding: 10px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .reaction-button:hover {
            background: #333;
            color: #fff;
        }

        .reaction-button.active {
            background: #ff4444;
            color: #fff;
            border-color: #ff4444;
        }

        .comment-section {
            margin-top: 30px;
        }

        .comment {
            padding: 20px;
            border-bottom: 1px solid #282828;
        }

        .comment:last-child {
            border-bottom: none;
        }

        .comment-meta {
            color: #888;
            font-size: 13px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        .comment-content {
            color: #fff;
            font-size: 14px;
            line-height: 1.6;
        }

        .separator {
            height: 1px;
            background: #282828;
            margin: 20px 0;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .info-label {
            color: #888;
        }

        .info-value {
            color: #fff;
            font-weight: 500;
        }

        .info-value a {
            color: #ff4444;
            text-decoration: none;
            cursor: pointer;
        }

        .info-value a:hover {
            text-decoration: underline;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .loading i {
            font-size: 40px;
            margin-bottom: 15px;
            color: #333;
        }

        .paste-url {
            background: #282828;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            font-size: 13px;
            word-break: break-all;
            border: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .copy-button {
            background: #444;
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .copy-button:hover {
            background: #555;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 30px;
        }

        .page-button {
            background: #282828;
            border: 1px solid #333;
            color: #888;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .page-button:hover:not(:disabled) {
            background: #333;
            color: #fff;
        }

        .page-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .profile-link {
            color: #ff4444;
            text-decoration: none;
            cursor: pointer;
            font-weight: 500;
        }

        .profile-link:hover {
            text-decoration: underline;
        }

        .user-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .navbar {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .search-box {
                width: 100%;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
                gap: 15px;
            }
            
            .paste-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .paste-meta {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <div class="navbar">
        <a onclick="loadHome()" class="logo">PASTEBIN</a>
        <div class="nav-links" id="navLinks">
            <a onclick="loadHome()">Home</a>
            <a onclick="showModal('upload')">Add Paste</a>
            <a onclick="loadUsers()">Users</a>
            <a onclick="showModal('login')">Login</a>
        </div>
        <input type="text" class="search-box" id="searchInput" placeholder="Search pastes, users..." onkeyup="searchContent()">
    </div>

    <!-- Main container -->
    <div class="container">
        <div class="main-content" id="mainContent">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading...</p>
            </div>
        </div>
        <div class="user-sidebar" id="userSidebar">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Login</h3>
                <span class="close" onclick="hideModal('login')">&times;</span>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="Enter your password">
            </div>
            <div id="loginError" class="error"></div>
            <button class="button button-primary" onclick="handleLogin()">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
            <p style="text-align: center; margin-top: 20px; font-size: 13px; color: #888;">
                Don't have an account? <a onclick="switchModal('login', 'register')" style="color: #ff4444; cursor: pointer;">Register</a>
            </p>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Register</h3>
                <span class="close" onclick="hideModal('register')">&times;</span>
            </div>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="regUsername" placeholder="Choose a username">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="regEmail" placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="regPassword" placeholder="Choose a password">
            </div>
            <div class="form-group">
                <label>Confirm Password</label>
                <input type="password" id="regConfirm" placeholder="Confirm password">
            </div>
            <div id="registerError" class="error"></div>
            <button class="button button-primary" onclick="handleRegister()">
                <i class="fas fa-user-plus"></i> Register
            </button>
            <p style="text-align: center; margin-top: 20px; font-size: 13px; color: #888;">
                Already have an account? <a onclick="switchModal('register', 'login')" style="color: #ff4444; cursor: pointer;">Login</a>
            </p>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Paste</h3>
                <span class="close" onclick="hideModal('upload')">&times;</span>
            </div>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('upload', 'text')">Text</button>
                <button class="tab" onclick="switchTab('upload', 'file')">File</button>
            </div>
            <div id="textTab" class="tab-content active">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="pasteTitle" placeholder="Enter paste title">
                </div>
                <div class="form-group">
                    <label>Content</label>
                    <textarea id="pasteContent" rows="10" placeholder="Enter paste content..."></textarea>
                </div>
                <div class="form-group">
                    <label>Syntax Highlighting</label>
                    <select id="pasteSyntax">
                        <option value="text">Plain Text</option>
                        <option value="javascript">JavaScript</option>
                        <option value="python">Python</option>
                        <option value="html">HTML</option>
                        <option value="css">CSS</option>
                        <option value="json">JSON</option>
                        <option value="sql">SQL</option>
                        <option value="bash">Bash</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Visibility</label>
                    <select id="pasteVisibility">
                        <option value="public">Public</option>
                        <option value="unlisted">Unlisted</option>
                        <option value="private">Private</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Expiration</label>
                    <select id="pasteExpiration">
                        <option value="never">Never</option>
                        <option value="1hour">1 Hour</option>
                        <option value="1day">1 Day</option>
                        <option value="1week">1 Week</option>
                        <option value="1month">1 Month</option>
                    </select>
                </div>
                <div id="uploadError" class="error"></div>
                <button class="button button-primary" onclick="handleUpload()">
                    <i class="fas fa-upload"></i> Create Paste
                </button>
            </div>
            <div id="fileTab" class="tab-content">
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>Click to upload or drag and drop</p>
                    <p style="font-size: 12px; color: #666;">Any file up to 10MB</p>
                    <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect()">
                </div>
                <div id="fileName" style="color: #888; margin-top: 10px;"></div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Profile</h3>
                <span class="close" onclick="hideModal('edit-profile')">&times;</span>
            </div>
            <div class="form-group">
                <label>Display Name</label>
                <input type="text" id="displayName" placeholder="Enter display name">
            </div>
            <div class="form-group">
                <label>Bio</label>
                <textarea id="bio" rows="4" placeholder="Tell us about yourself..."></textarea>
            </div>
            <div class="form-group">
                <label>Website</label>
                <input type="url" id="website" placeholder="https://...">
            </div>
            <div class="form-group">
                <label>Location</label>
                <input type="text" id="location" placeholder="City, Country">
            </div>
            <div class="form-group">
                <label>Banner URL</label>
                <input type="url" id="banner" placeholder="https://... (optional)">
            </div>
            <div id="profileError" class="error"></div>
            <button class="button button-primary" onclick="saveProfile()">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </div>
    </div>

    <!-- Avatar Upload Modal -->
    <div id="avatarModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Change Avatar</h3>
                <span class="close" onclick="hideModal('avatar')">&times;</span>
            </div>
            <div class="upload-area" onclick="document.getElementById('avatarInput').click()">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Click to upload avatar</p>
                <p style="font-size: 12px; color: #666;">PNG, JPG, GIF up to 5MB</p>
                <input type="file" id="avatarInput" style="display: none;" accept="image/*" onchange="handleAvatarSelect()">
            </div>
        </div>
    </div>

    <!-- View Paste Modal -->
    <div id="viewPasteModal" class="modal">
        <div class="modal-content" style="width: 800px;">
            <div class="modal-header">
                <h3 id="viewPasteTitle"></h3>
                <span class="close" onclick="hideModal('view-paste')">&times;</span>
            </div>
            <div id="pasteInfo" class="paste-view-meta"></div>
            <div id="pasteUrl" class="paste-url"></div>
            <pre id="pasteContent" class="paste-view-content"></pre>
            <div id="pasteReactions" class="reaction-buttons"></div>
            <div class="separator"></div>
            <div id="pasteComments" class="comment-section"></div>
            <div class="form-group" id="commentForm" style="display: none;">
                <textarea id="commentInput" placeholder="Add a comment..." rows="3"></textarea>
                <button class="button button-primary" onclick="addComment()">
                    <i class="fas fa-comment"></i> Post Comment
                </button>
            </div>
        </div>
    </div>

    <!-- View User Modal -->
    <div id="viewUserModal" class="modal">
        <div class="modal-content" style="width: 600px;">
            <div class="modal-header">
                <h3 id="viewUserTitle"></h3>
                <span class="close" onclick="hideModal('view-user')">&times;</span>
            </div>
            <div id="viewUserContent"></div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://ylgtgecqhdhakzbjdkqq.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_ILF6pER_bdL8GppxOzfumg_xsDoMA6T';
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                persistSession: true,
                autoRefreshToken: true,
                detectSessionInUrl: true
            }
        });

        // Global state
        let currentUser = null;
        let currentPage = 1;
        const ITEMS_PER_PAGE = 20;
        let currentPasteId = null;
        let currentViewUser = null;

        // Initialize app
        async function init() {
            await checkSession();
            setupAuthListener();
            await loadHome();
            await loadSidebar();
            
            // Check URL for paste ID
            const urlParams = new URLSearchParams(window.location.search);
            const pasteId = urlParams.get('p');
            if (pasteId) {
                await viewPaste(pasteId);
            }
        }

        // Check for existing session
        async function checkSession() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                if (session?.user) {
                    await loadUserProfile(session.user.id);
                }
            } catch (error) {
                console.error('Session check failed:', error);
            }
        }

        // Auth state listener
        function setupAuthListener() {
            supabase.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && session?.user) {
                    await loadUserProfile(session.user.id);
                    showToast('Logged in successfully!');
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    updateUI();
                    showToast('Logged out');
                }
                await loadSidebar();
            });
        }

        // Load user profile
        async function loadUserProfile(userId) {
            try {
                const { data: profile, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();

                if (error && error.code === 'PGRST116') {
                    // Profile doesn't exist yet, create it
                    const { data: user } = await supabase.auth.getUser();
                    const { data: newProfile, error: insertError } = await supabase
                        .from('profiles')
                        .insert({
                            id: userId,
                            username: user.user.email.split('@')[0],
                            display_name: user.user.email.split('@')[0]
                        })
                        .select()
                        .single();
                    
                    if (insertError) throw insertError;
                    currentUser = newProfile;
                } else if (error) {
                    throw error;
                } else {
                    currentUser = profile;
                }
                
                updateUI();
            } catch (error) {
                console.error('Failed to load profile:', error);
            }
        }

        // Load home page
        async function loadHome() {
            currentPage = 1;
            document.getElementById('mainContent').innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i><p>Loading pastes...</p></div>';
            
            try {
                const { data: pastes, error } = await supabase
                    .from('pastes')
                    .select(`
                        *,
                        profiles:user_id (
                            username,
                            display_name,
                            avatar_url
                        )
                    `)
                    .eq('visibility', 'public')
                    .order('created_at', { ascending: false })
                    .range(0, ITEMS_PER_PAGE - 1);

                if (error) throw error;

                renderPasteList(pastes || [], 'Recent Public Pastes');
            } catch (error) {
                console.error('Failed to load pastes:', error);
                document.getElementById('mainContent').innerHTML = '<div class="error">Failed to load pastes</div>';
            }
        }

        // Load users page
        async function loadUsers() {
            document.getElementById('mainContent').innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i><p>Loading users...</p></div>';
            
            try {
                const { data: profiles, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                renderUserList(profiles || []);
            } catch (error) {
                console.error('Failed to load users:', error);
                document.getElementById('mainContent').innerHTML = '<div class="error">Failed to load users</div>';
            }
        }

        // Load user's pastes
        async function loadUserPastes(userId, username) {
            document.getElementById('mainContent').innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i><p>Loading user pastes...</p></div>';
            
            try {
                const { data: pastes, error } = await supabase
                    .from('pastes')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('visibility', 'public')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                renderPasteList(pastes || [], `Pastes by ${username}`);
            } catch (error) {
                console.error('Failed to load user pastes:', error);
                document.getElementById('mainContent').innerHTML = '<div class="error">Failed to load pastes</div>';
            }
        }

        // Render paste list
        function renderPasteList(pastes, title) {
            let html = `
                <div class="paste-list">
                    <div class="paste-header">
                        <span>${title}</span>
                        <span>${pastes.length} pastes</span>
                    </div>
            `;

            if (pastes.length === 0) {
                html += '<div style="text-align: center; padding: 60px; color: #888;">No pastes yet</div>';
            } else {
                pastes.forEach(paste => {
                    html += `
                        <div class="paste-item" onclick="viewPaste('${paste.id}')">
                            <div>
                                <div class="paste-title">
                                    ${paste.title}
                                    ${paste.is_pinned ? '<span class="pinned-badge">PINNED</span>' : ''}
                                </div>
                                <div class="paste-meta">
                                    <span><i class="fas fa-user"></i> ${paste.profiles?.display_name || paste.profiles?.username || 'Unknown'}</span>
                                </div>
                            </div>
                            <div class="paste-meta">
                                <span><i class="fas fa-eye"></i> ${paste.views || 0}</span>
                                <span><i class="fas fa-calendar"></i> ${new Date(paste.created_at).toLocaleDateString()}</span>
                                <span><i class="fas fa-tag"></i> ${paste.syntax}</span>
                            </div>
                        </div>
                    `;
                });
            }

            html += `
                <div class="pagination">
                    <button class="page-button" onclick="changePage(-1)" ${currentPage === 1 ? 'disabled' : ''}>
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <span style="color: #888;">Page ${currentPage}</span>
                    <button class="page-button" onclick="changePage(1)" ${pastes.length < ITEMS_PER_PAGE ? 'disabled' : ''}>
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            `;

            document.getElementById('mainContent').innerHTML = html;
        }

        // Render user list
        function renderUserList(users) {
            let html = `
                <div class="paste-list">
                    <div class="paste-header">
                        <span>Users</span>
                        <span>${users.length} total</span>
                    </div>
            `;

            users.forEach(user => {
                html += `
                    <div class="paste-item" onclick="viewUser('${user.username}')">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: #333; overflow: hidden;">
                                ${user.avatar_url ? 
                                    `<img src="${user.avatar_url}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                    '<i class="fas fa-user" style="line-height: 40px; width: 100%; text-align: center;"></i>'
                                }
                            </div>
                            <div>
                                <div class="paste-title">${user.display_name || user.username}</div>
                                <div class="paste-meta">@${user.username}</div>
                            </div>
                        </div>
                        <div class="paste-meta">
                            <span><i class="fas fa-calendar"></i> Joined ${new Date(user.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            document.getElementById('mainContent').innerHTML = html;
        }

        // Load sidebar
        async function loadSidebar() {
            const sidebar = document.getElementById('userSidebar');
            
            if (!currentUser) {
                sidebar.innerHTML = `
                    <div style="text-align: center;">
                        <div class="avatar" style="margin: 0 auto 20px;">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="username">Guest</div>
                        <div class="user-bio">Login to create pastes and interact with the community</div>
                        <button class="button button-primary" onclick="showModal('login')">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                        <button class="button" onclick="showModal('register')">
                            <i class="fas fa-user-plus"></i> Register
                        </button>
                    </div>
                `;
                return;
            }

            try {
                // Get user stats
                const { count: pasteCount } = await supabase
                    .from('pastes')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', currentUser.id);

                const { count: followerCount } = await supabase
                    .from('followers')
                    .select('*', { count: 'exact', head: true })
                    .eq('following_id', currentUser.id);

                const { count: followingCount } = await supabase
                    .from('followers')
                    .select('*', { count: 'exact', head: true })
                    .eq('follower_id', currentUser.id);

                sidebar.innerHTML = `
                    <div class="profile-header">
                        <div class="banner" style="background-image: ${currentUser.banner_url ? `url('${currentUser.banner_url}')` : 'linear-gradient(45deg, #333, #444)'};"></div>
                        <div class="avatar" onclick="showModal('avatar')">
                            ${currentUser.avatar_url ? 
                                `<img src="${currentUser.avatar_url}">` : 
                                '<i class="fas fa-user"></i>'
                            }
                            <div class="avatar-upload">Change Avatar</div>
                        </div>
                    </div>
                    <div class="username">${currentUser.display_name || currentUser.username}</div>
                    <div class="user-bio">${currentUser.bio || 'No bio yet'}</div>
                    
                    <div class="user-stats">
                        <div class="stat" onclick="loadUserPastes('${currentUser.id}', '${currentUser.username}')" style="cursor: pointer;">
                            <div class="stat-value">${pasteCount || 0}</div>
                            <div class="stat-label">Pastes</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${followerCount || 0}</div>
                            <div class="stat-label">Followers</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${followingCount || 0}</div>
                            <div class="stat-label">Following</div>
                        </div>
                    </div>

                    ${currentUser.location ? `
                        <div style="margin: 10px 0; color: #888;">
                            <i class="fas fa-map-marker-alt"></i> ${currentUser.location}
                        </div>
                    ` : ''}

                    ${currentUser.website ? `
                        <div style="margin: 10px 0;">
                            <a href="${currentUser.website}" target="_blank" style="color: #ff4444; text-decoration: none;">
                                <i class="fas fa-globe"></i> ${currentUser.website.replace(/^https?:\/\//, '')}
                            </a>
                        </div>
                    ` : ''}

                    <button class="button" onclick="showModal('edit-profile')">
                        <i class="fas fa-edit"></i> Edit Profile
                    </button>
                    <button class="button button-primary" onclick="showModal('upload')">
                        <i class="fas fa-plus"></i> New Paste
                    </button>
                    <button class="button button-danger" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>

                    <div class="separator"></div>
                    
                    <div style="text-align: left;">
                        <div class="info-row">
                            <span class="info-label">Member since:</span>
                            <span class="info-value">${new Date(currentUser.created_at).toLocaleDateString()}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">User ID:</span>
                            <span class="info-value">${currentUser.id.slice(0, 8)}...</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load sidebar:', error);
            }
        }

        // View single paste
        async function viewPaste(pasteId) {
            currentPasteId = pasteId;
            
            // Update URL
            const url = new URL(window.location);
            url.searchParams.set('p', pasteId);
            window.history.pushState({}, '', url);

            try {
                // Increment view count
                await supabase.rpc('increment_paste_views', { paste_id: pasteId });

                // Get paste details
                const { data: paste, error: pasteError } = await supabase
                    .from('pastes')
                    .select(`
                        *,
                        profiles:user_id (
                            id,
                            username,
                            display_name,
                            avatar_url
                        )
                    `)
                    .eq('id', pasteId)
                    .single();

                if (pasteError) throw pasteError;

                // Get comments
                const { data: comments, error: commentsError } = await supabase
                    .from('comments')
                    .select(`
                        *,
                        profiles:user_id (
                            username,
                            display_name,
                            avatar_url
                        )
                    `)
                    .eq('paste_id', pasteId)
                    .order('created_at', { ascending: false });

                // Get reaction counts
                const { data: likes } = await supabase
                    .from('reactions')
                    .select('*', { count: 'exact', head: true })
                    .eq('paste_id', pasteId)
                    .eq('reaction_type', 'like');

                const { data: dislikes } = await supabase
                    .from('reactions')
                    .select('*', { count: 'exact', head: true })
                    .eq('paste_id', pasteId)
                    .eq('reaction_type', 'dislike');

                // Get user's reaction
                let userReaction = null;
                if (currentUser) {
                    const { data: reaction } = await supabase
                        .from('reactions')
                        .select('reaction_type')
                        .eq('paste_id', pasteId)
                        .eq('user_id', currentUser.id)
                        .maybeSingle();
                    
                    userReaction = reaction?.reaction_type;
                }

                // Display paste
                document.getElementById('viewPasteTitle').textContent = paste.title;
                document.getElementById('pasteContent').textContent = paste.content;
                
                // Generate URL
                const pasteUrl = `${window.location.origin}${window.location.pathname}?p=${paste.id}`;
                document.getElementById('pasteUrl').innerHTML = `
                    <span><i class="fas fa-link"></i> ${pasteUrl}</span>
                    <button class="copy-button" onclick="copyToClipboard('${pasteUrl}')">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                `;

                document.getElementById('pasteInfo').innerHTML = `
                    <span><i class="fas fa-user"></i> <a class="profile-link" onclick="viewUser('${paste.profiles.username}')">${paste.profiles.display_name || paste.profiles.username}</a></span>
                    <span><i class="fas fa-calendar"></i> ${new Date(paste.created_at).toLocaleString()}</span>
                    <span><i class="fas fa-eye"></i> ${paste.views || 0} views</span>
                    <span><i class="fas fa-tag"></i> ${paste.syntax}</span>
                    <span><i class="fas fa-globe"></i> ${paste.visibility}</span>
                `;

                document.getElementById('pasteReactions').innerHTML = `
                    <button class="reaction-button ${userReaction === 'like' ? 'active' : ''}" onclick="addReaction('${paste.id}', 'like')">
                        <i class="fas fa-thumbs-up"></i> ${likes?.length || 0}
                    </button>
                    <button class="reaction-button ${userReaction === 'dislike' ? 'active' : ''}" onclick="addReaction('${paste.id}', 'dislike')">
                        <i class="fas fa-thumbs-down"></i> ${dislikes?.length || 0}
                    </button>
                `;

                // Render comments
                let commentsHtml = '';
                if (comments && comments.length > 0) {
                    comments.forEach(comment => {
                        commentsHtml += `
                            <div class="comment">
                                <div class="comment-meta">
                                    <span>
                                        <img src="${comment.profiles?.avatar_url || ''}" style="width: 20px; height: 20px; border-radius: 50%; margin-right: 8px;">
                                        <a class="profile-link" onclick="viewUser('${comment.profiles?.username}')">${comment.profiles?.display_name || comment.profiles?.username}</a>
                                    </span>
                                    <span>${new Date(comment.created_at).toLocaleString()}</span>
                                </div>
                                <div class="comment-content">${comment.content}</div>
                            </div>
                        `;
                    });
                } else {
                    commentsHtml = '<div style="color: #888; text-align: center; padding: 30px;">No comments yet</div>';
                }

                document.getElementById('pasteComments').innerHTML = commentsHtml;
                
                document.getElementById('commentForm').style.display = currentUser ? 'block' : 'none';
                document.getElementById('commentInput').value = '';

                showModal('view-paste');
            } catch (error) {
                console.error('Failed to load paste:', error);
                showToast('Failed to load paste');
            }
        }

        // View user profile
        async function viewUser(username) {
            try {
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('username', username)
                    .single();

                if (profileError) throw profileError;

                currentViewUser = profile;

                // Get user's pastes
                const { data: userPastes, error: pastesError } = await supabase
                    .from('pastes')
                    .select('*')
                    .eq('user_id', profile.id)
                    .eq('visibility', 'public')
                    .order('created_at', { ascending: false })
                    .limit(10);

                // Get follower counts
                const { count: followers } = await supabase
                    .from('followers')
                    .select('*', { count: 'exact', head: true })
                    .eq('following_id', profile.id);

                const { count: following } = await supabase
                    .from('followers')
                    .select('*', { count: 'exact', head: true })
                    .eq('follower_id', profile.id);

                // Check if current user follows this user
                let isFollowing = false;
                if (currentUser) {
                    const { data: follow } = await supabase
                        .from('followers')
                        .select('*')
                        .eq('follower_id', currentUser.id)
                        .eq('following_id', profile.id)
                        .maybeSingle();
                    
                    isFollowing = !!follow;
                }

                document.getElementById('viewUserTitle').textContent = profile.display_name || profile.username;

                let html = `
                    <div style="text-align: center;">
                        <div class="avatar" style="margin: 0 auto 20px; width: 120px; height: 120px;">
                            ${profile.avatar_url ? 
                                `<img src="${profile.avatar_url}">` : 
                                '<i class="fas fa-user"></i>'
                            }
                        </div>
                        <div class="username">${profile.display_name || profile.username}</div>
                        <div class="user-bio">${profile.bio || 'No bio yet'}</div>
                        
                        ${profile.location ? `
                            <div style="margin: 10px 0; color: #888;">
                                <i class="fas fa-map-marker-alt"></i> ${profile.location}
                            </div>
                        ` : ''}

                        ${profile.website ? `
                            <div style="margin: 10px 0;">
                                <a href="${profile.website}" target="_blank" style="color: #ff4444; text-decoration: none;">
                                    <i class="fas fa-globe"></i> ${profile.website.replace(/^https?:\/\//, '')}
                                </a>
                            </div>
                        ` : ''}
                        
                        <div class="user-stats">
                            <div class="stat">
                                <div class="stat-value">${userPastes?.length || 0}</div>
                                <div class="stat-label">Pastes</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${followers || 0}</div>
                                <div class="stat-label">Followers</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${following || 0}</div>
                                <div class="stat-label">Following</div>
                            </div>
                        </div>
                `;

                if (currentUser && currentUser.id !== profile.id) {
                    html += `
                        <button class="button ${isFollowing ? 'button-danger' : 'button-primary'}" onclick="toggleFollow('${profile.id}')">
                            <i class="fas ${isFollowing ? 'fa-user-minus' : 'fa-user-plus'}"></i>
                            ${isFollowing ? 'Unfollow' : 'Follow'}
                        </button>
                    `;
                } else if (currentUser && currentUser.id === profile.id) {
                    html += `
                        <button class="button" onclick="showModal('edit-profile')">
                            <i class="fas fa-edit"></i> Edit Profile
                        </button>
                    `;
                }

                html += `
                    <div class="separator"></div>
                    <h4 style="text-align: left; margin-bottom: 15px;">Recent Pastes</h4>
                `;

                if (userPastes && userPastes.length > 0) {
                    userPastes.forEach(paste => {
                        html += `
                            <div class="paste-item" onclick="viewPaste('${paste.id}')">
                                <div>
                                    <div class="paste-title">${paste.title}</div>
                                </div>
                                <div class="paste-meta">
                                    <span><i class="fas fa-eye"></i> ${paste.views || 0}</span>
                                    <span>${new Date(paste.created_at).toLocaleDateString()}</span>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += '<div style="color: #888; text-align: center; padding: 20px;">No public pastes yet</div>';
                }

                html += '</div>';
                document.getElementById('viewUserContent').innerHTML = html;
                showModal('view-user');
            } catch (error) {
                console.error('Failed to load user:', error);
                showToast('Failed to load user profile');
            }
        }

        // Handle login
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            if (!email || !password) {
                errorDiv.textContent = 'Please fill in all fields';
                return;
            }

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                hideModal('login');
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                errorDiv.textContent = '';
            } catch (error) {
                errorDiv.textContent = error.message;
            }
        }

        // Handle register
        async function handleRegister() {
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const confirm = document.getElementById('regConfirm').value;
            const errorDiv = document.getElementById('registerError');

            if (!username || !email || !password || !confirm) {
                errorDiv.textContent = 'Please fill in all fields';
                return;
            }

            if (password !== confirm) {
                errorDiv.textContent = 'Passwords do not match';
                return;
            }

            if (password.length < 6) {
                errorDiv.textContent = 'Password must be at least 6 characters';
                return;
            }

            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            username: username,
                            display_name: username
                        }
                    }
                });

                if (error) throw error;

                showToast('Registered successfully! Please check your email for confirmation.');
                hideModal('register');
                document.getElementById('regUsername').value = '';
                document.getElementById('regEmail').value = '';
                document.getElementById('regPassword').value = '';
                document.getElementById('regConfirm').value = '';
                errorDiv.textContent = '';
            } catch (error) {
                errorDiv.textContent = error.message;
            }
        }

        // Handle logout
        async function handleLogout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        // Handle upload
        async function handleUpload() {
            if (!currentUser) {
                showToast('Please login to create pastes');
                showModal('login');
                return;
            }

            const title = document.getElementById('pasteTitle').value;
            const content = document.getElementById('pasteContent').value;
            const syntax = document.getElementById('pasteSyntax').value;
            const visibility = document.getElementById('pasteVisibility').value;
            const expiration = document.getElementById('pasteExpiration').value;
            const errorDiv = document.getElementById('uploadError');

            if (!title || !content) {
                errorDiv.textContent = 'Please fill in all fields';
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('pastes')
                    .insert({
                        title: title,
                        content: content,
                        syntax: syntax,
                        visibility: visibility,
                        expiration: expiration,
                        user_id: currentUser.id
                    })
                    .select()
                    .single();

                if (error) throw error;

                showToast('Paste created successfully!');
                hideModal('upload');
                document.getElementById('pasteTitle').value = '';
                document.getElementById('pasteContent').value = '';
                document.getElementById('uploadError').textContent = '';
                
                // Open the new paste
                await viewPaste(data.id);
            } catch (error) {
                errorDiv.textContent = error.message;
            }
        }

        // Handle file select
        function handleFileSelect() {
            const file = document.getElementById('fileInput').files[0];
            if (file) {
                document.getElementById('fileName').innerHTML = `Selected: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('pasteContent').value = e.target.result;
                    document.getElementById('pasteTitle').value = file.name.replace(/\.[^/.]+$/, '');
                    switchTab('upload', 'text');
                };
                reader.readAsText(file);
            }
        }

        // Save profile
        async function saveProfile() {
            if (!currentUser) return;

            const displayName = document.getElementById('displayName').value;
            const bio = document.getElementById('bio').value;
            const website = document.getElementById('website').value;
            const location = document.getElementById('location').value;
            const banner = document.getElementById('banner').value;

            try {
                const { error } = await supabase
                    .from('profiles')
                    .update({
                        display_name: displayName || currentUser.username,
                        bio: bio,
                        website: website,
                        location: location,
                        banner_url: banner,
                        updated_at: new Date()
                    })
                    .eq('id', currentUser.id);

                if (error) throw error;

                currentUser = { 
                    ...currentUser, 
                    display_name: displayName || currentUser.username,
                    bio, 
                    website, 
                    location,
                    banner_url: banner
                };
                
                showToast('Profile updated!');
                hideModal('edit-profile');
                await loadSidebar();
            } catch (error) {
                document.getElementById('profileError').textContent = error.message;
            }
        }

        // Handle avatar upload
        async function handleAvatarSelect() {
            const file = document.getElementById('avatarInput').files[0];
            if (!file || !currentUser) return;

            // Check file size (5MB limit)
            if (file.size > 5 * 1024 * 1024) {
                showToast('File too large. Max 5MB');
                return;
            }

            try {
                const fileExt = file.name.split('.').pop();
                const fileName = `${currentUser.id}-${Date.now()}.${fileExt}`;
                const filePath = `avatars/${fileName}`;

                // Upload to Supabase Storage
                const { error: uploadError } = await supabase.storage
                    .from('avatars')
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (uploadError) throw uploadError;

                // Get public URL
                const { data: { publicUrl } } = supabase.storage
                    .from('avatars')
                    .getPublicUrl(filePath);

                // Update profile
                const { error: updateError } = await supabase
                    .from('profiles')
                    .update({ avatar_url: publicUrl })
                    .eq('id', currentUser.id);

                if (updateError) throw updateError;

                currentUser.avatar_url = publicUrl;
                showToast('Avatar updated!');
                hideModal('avatar');
                await loadSidebar();
            } catch (error) {
                console.error('Avatar upload failed:', error);
                showToast('Failed to upload avatar');
            }
        }

        // Add reaction
        async function addReaction(pasteId, type) {
            if (!currentUser) {
                showToast('Please login to react');
                showModal('login');
                return;
            }

            try {
                // Check if user already reacted
                const { data: existing } = await supabase
                    .from('reactions')
                    .select('*')
                    .eq('paste_id', pasteId)
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (existing) {
                    if (existing.reaction_type === type) {
                        // Remove reaction
                        await supabase
                            .from('reactions')
                            .delete()
                            .eq('id', existing.id);
                    } else {
                        // Update reaction
                        await supabase
                            .from('reactions')
                            .update({ reaction_type: type })
                            .eq('id', existing.id);
                    }
                } else {
                    // Add new reaction
                    await supabase
                        .from('reactions')
                        .insert({
                            paste_id: pasteId,
                            user_id: currentUser.id,
                            reaction_type: type
                        });
                }

                // Refresh paste view
                viewPaste(pasteId);
            } catch (error) {
                console.error('Failed to add reaction:', error);
            }
        }

        // Add comment
        async function addComment() {
            if (!currentUser) {
                showToast('Please login to comment');
                showModal('login');
                return;
            }

            if (!currentPasteId) return;

            const content = document.getElementById('commentInput').value;

            if (!content) return;

            try {
                const { error } = await supabase
                    .from('comments')
                    .insert({
                        paste_id: currentPasteId,
                        user_id: currentUser.id,
                        content: content
                    });

                if (error) throw error;

                showToast('Comment added!');
                document.getElementById('commentInput').value = '';
                viewPaste(currentPasteId);
            } catch (error) {
                console.error('Failed to add comment:', error);
            }
        }

        // Toggle follow
        async function toggleFollow(userId) {
            if (!currentUser) {
                showToast('Please login to follow users');
                showModal('login');
                return;
            }

            try {
                const { data: existing } = await supabase
                    .from('followers')
                    .select('*')
                    .eq('follower_id', currentUser.id)
                    .eq('following_id', userId)
                    .maybeSingle();

                if (existing) {
                    await supabase
                        .from('followers')
                        .delete()
                        .eq('id', existing.id);
                    showToast('Unfollowed');
                } else {
                    await supabase
                        .from('followers')
                        .insert({
                            follower_id: currentUser.id,
                            following_id: userId
                        });
                    showToast('Following');
                }

                hideModal('view-user');
                if (currentViewUser) {
                    viewUser(currentViewUser.username);
                }
            } catch (error) {
                console.error('Failed to toggle follow:', error);
            }
        }

        // Search content
        async function searchContent() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            
            if (!query) {
                await loadHome();
                return;
            }

            try {
                const { data: pastes, error } = await supabase
                    .rpc('search_public_pastes', { search_query: query });

                if (error) throw error;

                renderPasteList(pastes || [], `Search Results for "${query}"`);
            } catch (error) {
                console.error('Search failed:', error);
            }
        }

        // Change page
        async function changePage(direction) {
            currentPage += direction;
            if (currentPage < 1) currentPage = 1;
            await loadHome();
        }

        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!');
            });
        }

        // Modal functions
        function showModal(modalName) {
            if ((modalName === 'upload' || modalName === 'edit-profile') && !currentUser) {
                showToast('Please login first');
                showModal('login');
                return;
            }
            
            if (modalName === 'edit-profile' && currentUser) {
                document.getElementById('displayName').value = currentUser.display_name || '';
                document.getElementById('bio').value = currentUser.bio || '';
                document.getElementById('website').value = currentUser.website || '';
                document.getElementById('location').value = currentUser.location || '';
                document.getElementById('banner').value = currentUser.banner_url || '';
            }
            
            document.getElementById(modalName + 'Modal').classList.add('active');
        }
        
        function hideModal(modalName) {
            document.getElementById(modalName + 'Modal').classList.remove('active');
            
            // Clear errors
            if (modalName === 'login') document.getElementById('loginError').textContent = '';
            if (modalName === 'register') document.getElementById('registerError').textContent = '';
            if (modalName === 'upload') document.getElementById('uploadError').textContent = '';
            if (modalName === 'edit-profile') document.getElementById('profileError').textContent = '';
        }
        
        function switchModal(hide, show) {
            hideModal(hide);
            showModal(show);
        }
        
        function switchTab(modal, tab) {
            document.querySelectorAll(`#${modal}Modal .tab`).forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll(`#${modal}Modal .tab-content`).forEach(c => c.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        // Toast function
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // Update UI based on auth state
        function updateUI() {
            const navLinks = document.getElementById('navLinks');
            if (currentUser) {
                navLinks.innerHTML = `
                    <a onclick="loadHome()">Home</a>
                    <a onclick="showModal('upload')">Add Paste</a>
                    <a onclick="loadUsers()">Users</a>
                    <a onclick="viewUser('${currentUser.username}')">Profile</a>
                    <a onclick="handleLogout()">Logout</a>
                `;
            } else {
                navLinks.innerHTML = `
                    <a onclick="loadHome()">Home</a>
                    <a onclick="showModal('upload')">Add Paste</a>
                    <a onclick="loadUsers()">Users</a>
                    <a onclick="showModal('login')">Login</a>
                `;
            }
            loadSidebar();
        }

        // Handle browser back/forward
        window.onpopstate = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const pasteId = urlParams.get('p');
            
            if (pasteId) {
                viewPaste(pasteId);
            } else {
                loadHome();
            }
        };

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        };

        // Initialize
        init();
    </script>
</body>
</html>
